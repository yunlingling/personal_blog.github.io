---
layout:     post
title:      一些python程序
subtitle:   python
date:       2020-12-13
author:     yunlingling
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - python
---

<h6>1. python获取gpu id</h6>
```
import os
result = os.popen('nvidia-smi -L |awk "{ print $1 }"').readlines()
gpus = [gpu.split()[1][:-1] for gpu in result]
os.environ["CUDA_VISIBLE_DEVICES"] = ','.join(gpus)
```

<h6>2. 在子目录运行py文件</h6>
```
import os, sys
sys.path.append('.')
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
```

<h6>3.flask单元测试</h6>
a.py
```

from flask import Flask, request

app = Flask(__name__)


@app.route('/test', methods=["POST"])
def func():
    json_data = request.get_json()
    info = json_data.get("info", 'nothing')
    return info


if __name__ == '__main__':
    app.run('0.0.0.0', port=5000)
```
b.py
```
import unittest
from tests.a import app


class TestUnit(unittest.TestCase):
    def setUp(self) -> None:
        self.app = app.test_client()

    def test_func(self):
        json_data = {"info": "info"}
        response = self.app.post('/test', json=json_data)
        self.assertEqual(response.status_code, 200)

```


<h6>4.关于pip、pip3指向python解释器</h6>
```
which pip3
```
找到pip3所在文件/usr/bin/pip3
```
vim /usr/bin/pip3
```
修改#!/usr/bin/python3为解释器路径
```
#!/usr/bin/python3
# GENERATED BY DEBIAN

import sys

# Run the main entry point, similarly to how setuptools does it, but because
# we didn't install the actual entry point from setup.py, don't use the
# pkg_resources API.
from pip import main
if __name__ == '__main__':
    sys.exit(main())
```
```
#!/miniconda/bin/python
# GENERATED BY DEBIAN

import sys

# Run the main entry point, similarly to how setuptools does it, but because
# we didn't install the actual entry point from setup.py, don't use the
# pkg_resources API.
from pip import main
if __name__ == '__main__':
    sys.exit(main())
```
<h6>5.cv2与二进制互转</h6>
```
im_np = cv2.imdecode(np.asarray(bytearray(im_bytes), dtype='uint8'), cv2.IMREAD_COLOR)
im_bytes = np.array(cv2.imencode('.jpg', im_np)[1]).tobytes()


image_bin = cv2.imencode('.jpg', im_np, [cv2.IMWRITE_JPEG_QUALITY, quality])[1].tobytes()
```

<h6>6.python调用class的多线程</h6>
```
from multiprocessing.pool import Pool


class A(object):

    def __init__(self, a, b):
        self.a = a
        self.b = b

    def process(self, c):
        import time
        time.sleep(2)
        print(self.add() + c)

    def add(self):
        return self.a + self.b


def my_func(a, b, c):
    print(a)
    a = A(a, b)
    a.process(c)

p = Pool(4)
# 注意Pool创建必须在函数之后，否则无法找到函数

for i in range(4):
    p.apply_async(my_func, args=(i, i, i))

p.close()
p.join()
```
将实例化的类改成静态方法，也可多包一层函数方法

<h6>7.反射模块</h6>
```
import importlib
mokuai = importlib.import_module("my_module.mokuai")
myClass = getattr(mokuai, "Manager")
```
my_module为目录,其中__ini__.py导入py文件
Manager为文件中的类


<h6>8.flask中FileStorge转BufferReader</h6>
```
file_ = request.forms.get('file')
file_.name = file_.filename
file_buffer = BufferReader(file_)
data = {'file': file_buffer}
request.post(url, files=data)
```
